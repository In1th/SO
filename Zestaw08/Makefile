# =========================================================================
# Makefile
# =========================================================================
# autor: Mateusz Kruk, grupa 7.
# utworzony: 11.05.2021
# modyfikowany ostatnio: 11.05.2021
# =========================================================================

# =========================================================================
# Makrodefinicje
# =========================================================================

# -------------------------------------------------------------------------
# Nazwa zestawu
# -------------------------------------------------------------------------

MODULE := Zestaw08
NAME := Mateusz
SURNAME := Kruk

# -------------------------------------------------------------------------
# Nazwy zadań
# -------------------------------------------------------------------------

LIB := msg
ZAD2A := serwer
ZAD2B := klient

# -------------------------------------------------------------------------
# Nazwy plików wykonywalnych
# -------------------------------------------------------------------------

EXEC2A := $(ZAD2A).x
EXEC2B := $(ZAD2B).x

# -------------------------------------------------------------------------
# Makrodefinicje kompilacji i linkowania
# -------------------------------------------------------------------------

CC := gcc 
CFLAGS := -Wall -std=c99 -pedantic -O -fPIC
LFLAGS := -Wall -std=c99 -pedantic -O
LDLIBS := -lrt
LIB_DIR = .
LIB_CREATE := ar rv
LIB_SHAR := lib$(LIB).so
LIB_STAT := lib$(LIB).a

# =========================================================================
# Reguły
# =========================================================================

# -------------------------------------------------------------------------
# Reguły nieodwołujące się do plików
# -------------------------------------------------------------------------

.PHONY: all archive clean clean_o run

all: $(LIBS) $(EXEC2A) $(EXEC2B) clean_o


# -------------------------------------------------------------------------
# Reguły wzorcowe
# -------------------------------------------------------------------------

%.x: %.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

# -------------------------------------------------------------------------
# Tworzenie bibliotek
# -------------------------------------------------------------------------

$(LIB_STAT): $(LIB)1.o
	$(LIB_CREATE) $@ $<

$(LIB_SHAR): $(LIB)2.o
	$(CC) -shared -o $@ $<

$(LIB)1.o: $(LIB).c
	$(CC) -c -o $@ $<

$(LIB)2.o: $(LIB).c
	$(CC) -o $@ -c $< -O -fPIC

# -------------------------------------------------------------------------
# Linkowanie prgramów z zadania 2
# -------------------------------------------------------------------------

$(EXEC2A): $(ZAD2A).o $(LIB_SHAR)
	$(CC) -o $@ $(LFLAGS) $(ZAD2A).o -L$(LIB_DIR) -l$(LIB) $(LDLIBS) -Wl,-R $(LIB_DIR)

$(EXEC2B): $(ZAD2B).o $(LIB_SHAR)
	$(CC) -o $@ $(LFLAGS) $(ZAD2B).o -L$(LIB_DIR) -l$(LIB) $(LDLIBS) -Wl,-R $(LIB_DIR)

# -------------------------------------------------------------------------
# Linkowanie i kompilowanie prgramów z zadania 3
# -------------------------------------------------------------------------


run: $(EXEC2A) $(EXEC2B)
	xterm -hold -title SERWER -bg red -e ./serwer.x &
	xterm -hold -title KLIENT1 -bg green -fg black -e ./klient.x &
	xterm -hold -title KLIENT2 -bg green -fg black -e ./klient.x &

# -------------------------------------------------------------------------
# Reguła archiwizująca cały Zestaw
# -------------------------------------------------------------------------

archive: clean
	(cd ../; tar -cvzf $(NAME)$(SURNAME)_$(MODULE).tar.gz  $(MODULE) )

# -------------------------------------------------------------------------
# Reguła czyszcząca pliki tymczasowe
# -------------------------------------------------------------------------

clean:
	$(RM) *.[oxa]
	$(RM) *.so

clean_o:
	$(RM) *.o

# =========================================================================
