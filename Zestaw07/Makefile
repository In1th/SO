# =========================================================================
# Makefile
# =========================================================================
# autor: Mateusz Kruk, grupa 7.
# utworzony: 3.05.2021
# modyfikowany ostatnio: 10.05.2021
# =========================================================================

# =========================================================================
# Makrodefinicje
# =========================================================================

# -------------------------------------------------------------------------
# Nazwa zestawu
# -------------------------------------------------------------------------

MODULE := Zestaw07
NAME := Mateusz
SURNAME := Kruk

# -------------------------------------------------------------------------
# Nazwy zadań
# -------------------------------------------------------------------------

LIB1 := shmem
LIB2 := sem
ZAD2 := shmuse
ZAD3 := glowny
ZAD3A := producent
ZAD3B := konsument

# -------------------------------------------------------------------------
# Nazwy plików wykonywalnych
# -------------------------------------------------------------------------

EXEC2d1 := $(ZAD2)1.x
EXEC2d2 := $(ZAD2)2.x
OBJS2 = $(ZAD2).o
EXEC3 := $(ZAD3).x
EXEC3A := $(ZAD3A).x
EXEC3B := $(ZAD3B).x

# -------------------------------------------------------------------------
# Makrodefinicje kompilacji i linkowania
# -------------------------------------------------------------------------

CC := gcc 
CFLAGS := -Wall -std=c99 -pedantic -O -fPIC
LFLAGS := -Wall -std=c99 -pedantic -O
LDLIBS := -lrt
LIB_DIR = .
LIB_CREATE := ar rv
LIB_SHAR := lib$(LIB1).so
LIB_STAT := lib$(LIB2).a
LIBS = lib$(LIB1).so lib$(LIB2).a

# =========================================================================
# Reguły
# =========================================================================

# -------------------------------------------------------------------------
# Reguły nieodwołujące się do plików
# -------------------------------------------------------------------------

.PHONY: all archive clean clean_o

all: $(LIBS) $(EXEC2d1) $(EXEC2d2) $(EXEC3) clean_o


# -------------------------------------------------------------------------
# Reguły wzorcowe
# -------------------------------------------------------------------------

%.x: %.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

# -------------------------------------------------------------------------
# Tworzenie bibliotek
# -------------------------------------------------------------------------

lib$(LIB1).so: $(LIB1).o
	$(CC) -shared -o $@ $<

$(LIB1).o: $(LIB1).c
	$(CC) -c $< -O -fPIC

lib$(LIB2).a: $(LIB2).o
	$(LIB_CREATE) $@ $<

$(LIB2).o: $(LIB2).c
	gcc -c $< -o $@

# -------------------------------------------------------------------------
# Linkowanie prgramów z zadania 2
# -------------------------------------------------------------------------

$(EXEC2d1): $(OBJS2) $(LIB_SHAR)
	$(CC) -o $@ $(LFLAGS) $(OBJS2) -L$(LIB_DIR) -l$(LIB1) $(LDLIBS) -Wl,-R $(LIB_DIR)

$(EXEC2d2): $(OBJS2) $(LIB_SHAR)
	$(CC) -o $@ $(LFLAGS) $(OBJS2) -L$(LIB_DIR) -l$(LIB1) $(LDLIBS)

# -------------------------------------------------------------------------
# Linkowanie i kompilowanie prgramów z zadania 3
# -------------------------------------------------------------------------


$(EXEC3): $(ZAD3).o bufor.o $(LIB_SHAR) $(LIB_STAT) 
	$(CC) -pthread -o $@ $(LFLAGS) $(ZAD3).o bufor.o -L$(LIB_DIR) -l$(LIB1) -l$(LIB2) $(LDLIBS) -Wl,-R $(LIB_DIR)

$(ZAD3).o : $(ZAD3).c $(EXEC3A) $(EXEC3B)

$(EXEC3A): $(ZAD3A).o bufor.o $(LIB_SHAR) $(LIB_STAT)
	$(CC) -pthread -o $@ $(LFLAGS) $(ZAD3A).o bufor.o -L$(LIB_DIR) -l$(LIB1) -l$(LIB2) $(LDLIBS) -Wl,-R $(LIB_DIR)

$(EXEC3B): $(ZAD3B).o bufor.o $(LIB_SHAR) $(LIB_STAT)
	$(CC) -pthread -o $@ $(LFLAGS) $(ZAD3B).o bufor.o -L$(LIB_DIR) -l$(LIB1) -l$(LIB2) $(LDLIBS) -Wl,-R $(LIB_DIR)

# -------------------------------------------------------------------------
# Reguła archiwizująca cały Zestaw
# -------------------------------------------------------------------------

archive: clean
	(cd ../; tar -cvzf $(NAME)$(SURNAME)_$(MODULE).tar.gz  $(MODULE) )

# -------------------------------------------------------------------------
# Reguła czyszcząca pliki tymczasowe
# -------------------------------------------------------------------------

clean:
	$(RM) *.[oxa]
	$(RM) *.so

clean_o:
	$(RM) *.o

# =========================================================================
